---
title: "Urban Growth Modeling"
author: "Javier Fernandez, Lu Yii Wong"
date: "2024-04-30"
output: html_document

---
# 1: Setup 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r load_packages, message=FALSE, warning=FALSE, results = "hide"}
library(tidyverse)
library(sf)
library(raster)
library(knitr)
library(kableExtra)
library(tidycensus)
library(tigris)
library(FNN)
library(tiff)
#library(QuantPsyc) # JE Note: in R 4.1, QuantPsyc package not available.
library(caret)
library(yardstick)
library(pscl)
library(plotROC) 
library(ggrepel)
library(pROC)
library(grid)
library(gridExtra)
library(viridis)
library(igraph)

plotTheme <- theme(
  plot.title =element_text(size=12),
  plot.subtitle = element_text(size=8),
  plot.caption = element_text(size = 6),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title.y = element_text(size = 10),
  # Set the entire chart region to blank
  panel.background=element_blank(),
  plot.background=element_blank(),
  #panel.border=element_rect(colour="#F0F0F0"),
  # Format the grid
  panel.grid.major=element_line(colour="#D0D0D0",size=.75),
  axis.ticks=element_blank())

mapTheme <- theme(plot.title =element_text(size=12),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 6),
                  axis.line=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border=element_blank(),
                  panel.grid.major=element_line(colour = 'transparent'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))

palette2 <- c("#41b6c4","#253494")
palette4 <- c("#a1dab4","#41b6c4","#2c7fb8","#253494")
palette5 <- c("#ffffcc","#a1dab4","#41b6c4","#2c7fb8","#253494")
palette10 <- c("#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4",
               "#4eb3d3","#2b8cbe","#0868ac","#084081","#f7fcf0")
```


```{r, warning = FALSE, message = FALSE}
#this function converts a column in to quintiles. It is used for mapping.
quintileBreaks <- function(df,variable) {
    as.character(quantile(df[[variable]],
                          c(.01,.2,.4,.6,.8),na.rm=T))
}

#This function can be used to convert a polygon sf to centroids xy coords.
xyC <- function(aPolygonSF) {
  as.data.frame(
    cbind(x=st_coordinates(st_centroid(aPolygonSF))[,1],
          y=st_coordinates(st_centroid(aPolygonSF))[,2]))
} 

#this function convert a raster to a data frame so it can be plotted in ggplot
rast <- function(inRaster) {
  data.frame(
    xyFromCell(inRaster, 1:ncell(inRaster)), 
    value = getValues(inRaster)) }
```

# 2: Data Wrangling
## 2.1: Land Cover 
```{r load_data, warning = FALSE, message = FALSE, results = "hide"}

njMSA <- st_read("/Users/luyiiwong/Documents/GitHub/LandUseModeling_HW5/Data/nj_counties_msa.geojson")

lc_change = raster("/Users/luyiiwong/Documents/GitHub/LandUseModeling_HW5/Data/nlcd_nj_msa/nlcd_nj_msa.tif")
```


## plot MSA
```{r plot_msa, warning= FALSE, message= FALSE}
ggplot() +
  geom_sf(data=njMSA) +
  geom_raster(data=rast(lc_change) %>% na.omit %>% filter(value > 0), 
              aes(x,y,fill=as.factor(value))) +
  scale_fill_viridis(direction = -1, discrete=TRUE, name ="Land Cover\nChange") +
  labs(title = "Land Cover Change, 2011-2021") +
  mapTheme +
  theme(legend.direction="horizontal")
```

## reclassify land cover change 
```{r, warning = FALSE, message = FALSE}
reclassMatrix <- matrix(c(
  0, 2, 0,
  3, 3, 1,
  3, Inf, 0),
  ncol = 3, byrow = TRUE)

reclassMatrix
```

```{r, warning = FALSE, message = FALSE}
lc_change2 <- 
  reclassify(lc_change,reclassMatrix)

lc_change2[lc_change2 < 1] <- NA

names(lc_change2) <- "lc_change"

ggplot() +
  geom_sf(data=njMSA) +
  geom_raster(data=rast(lc_change2) %>% na.omit, 
              aes(x,y,fill=as.factor(value))) +
  scale_fill_viridis(discrete=TRUE, name ="Land Cover\nChange") + 
  labs(title="Development Land Use Change") +
  mapTheme
```

## fishnet
```{r, warning = FALSE, message = FALSE}
njMSA_fishnet <- 
  st_make_grid(njMSA, 500) %>%
  st_sf()

njMSA_fishnet <-
  njMSA_fishnet[njMSA,]

ggplot() +
  geom_sf(data=njMSA_fishnet) +
  labs(title="Fishnet, 500 Foot Resolution") +
  mapTheme
```

```{r, warning = FALSE, message = FALSE}
changePoints <-
  rasterToPoints(lc_change2) %>%
  as.data.frame() %>%
  st_as_sf(coords = c("x", "y"), crs = st_crs(njMSA_fishnet))

fishnet <- 
  aggregate(changePoints, njMSA_fishnet, sum) %>%
  mutate(lc_change = ifelse(is.na(lc_change),0,1),
         lc_change = as.factor(lc_change))

ggplot() +
  geom_sf(data=njMSA) +
  geom_point(data=fishnet, 
             aes(x=xyC(fishnet)$x, y=xyC(fishnet)$y, colour=lc_change)) +
  scale_colour_manual(values = palette2,
                      labels=c("No Change","New Development"),
                      name = "") +
  labs(title = "Land Cover Development Change", subtitle = "As fishnet centroids") +
  mapTheme
```
# 2.2 land cover change 2011
```{r, warning = FALSE, message = FALSE}
lc_2011 <- raster("/Users/luyiiwong/Documents/GitHub/LandUseModeling_HW5/Data/lc_nj_msa_2011.tif.aux/lc_nj_msa_2011.tif")

ggplot() +
  geom_sf(data=njMSA) +
  geom_raster(data=rast(lc_2011) %>% na.omit %>% filter(value > 0), 
              aes(x,y,fill=as.factor(value))) +
  scale_fill_viridis(discrete=TRUE, name ="") +
  labs(title = "Land Cover, 2011") +
  mapTheme +
  theme(legend.direction="horizontal")

#### trying to recolor based on MRLC categorization
## FIGURE THIS OUT
LCcodes <- unique(lc_2011)

LCnames <-c(
  "Water",
  "DevelopedOpen",
  "DevelopedLow",
  "DevelopedMed",
  "DevelopedHigh",
  "Barren",
  "DeciduousForest",
  "EvergreenForest",
  "MixedForest",
  "ShrubScrub",
  "GrassHerbaceous",
  "PastureHay",
  "CultCrops",
  "WoodyWetlands",
  "EmergentHerbWet")
```


# 2.3: ACS Data 

```{r}
# setting up api key 
census_api_key("b83a23afee4a8ed0fa131e449869e6577b87151e", overwrite = TRUE, install = TRUE)
```

```{r}
# creating list for selected counties
selected_counties <- c("Bergen County, New Jersey", "Hudson County, New Jersey", "Passaic County, New Jersey" , 
                       "Middlesex County, New Jersey", "Monmouth County, New Jersey", "Ocean County, New Jersey", 
                       "Somerset County, New Jersey", "Essex County, New Jersey", "Union County, New Jersey",
                       "Morris County, New Jersey", "Sussex County, New Jersey", "Hunterdon County, New Jersey",
                       "Mercer County, New Jersey", "Warren County, New Jersey")

# pulling data from census for 2011
dat_2011 <- get_acs(geography = "county", 
          variables = c("B01003_001E",
                        "B19013_001E"), 
          year = 2011, 
          state = "NJ", 
          geometry = TRUE, 
          output = "wide") %>%
  rename(total_pop = B01003_001E,
         median_hh_income = B19013_001E) %>%
  dplyr::select(GEOID, NAME, total_pop, median_hh_income, geometry) %>%
  filter(NAME %in% selected_counties)



# pulling data from census for 2021
dat_2021 <- get_acs(geography = "county", 
          variables = c("B01003_001E",
                        "B19013_001E"), 
          year = 2021, 
          state = "NJ", 
          geometry = TRUE, 
          output = "wide") %>%
  rename(total_pop = B01003_001E,
         median_hh_income = B19013_001E) %>%
  dplyr::select(GEOID, NAME, total_pop, median_hh_income, geometry) %>%
  filter(NAME %in% selected_counties)

```

## plotting population 

```{r, warning = FALSE, message = FALSE, fig.height= 8, fig.width= 11}
grid.arrange(
ggplot() +
  geom_sf(data = dat_2011, aes(fill=factor(ntile(total_pop,5))), colour=NA) +
  scale_fill_manual(values = palette5,
                    labels=quintileBreaks(dat_2011,"total_pop"),
                   name="Quintile\nBreaks") +
  labs(title="Population, New Jersey (select counties): 2011") +
  mapTheme,

ggplot() +
  geom_sf(data = dat_2021, aes(fill=factor(ntile(total_pop,5))), colour=NA) +
  scale_fill_manual(values = palette5,
                    labels=quintileBreaks(dat_2021,"total_pop"),
                   name="Quintile\nBreaks") +
  labs(title="Population, New Jersey (select counties): 2021") +
  mapTheme, ncol=2)
```


# plotting by census tract 
```{r}
# creating list for selected counties
selected_counties <- c("Bergen County, New Jersey", "Hudson County, New Jersey", "Passaic County, New Jersey" , 
                       "Middlesex County, New Jersey", "Monmouth County, New Jersey", "Ocean County, New Jersey", 
                       "Somerset County, New Jersey", "Essex County, New Jersey", "Union County, New Jersey",
                       "Morris County, New Jersey", "Sussex County, New Jersey", "Hunterdon County, New Jersey",
                       "Mercer County, New Jersey", "Warren County, New Jersey")

# pulling data from census for 2011
dat_2011_tract <- get_acs(geography = "tract", 
          variables = c("B01003_001E"), 
          year = 2011, 
          state = "NJ", 
          county = c("Bergen", "Hudson", "Passaic", "Middlesex", "Monmouth", "Ocean", "Somerset",
                     "Essex", "Union", "Morris", "Sussex", "Hunterdon", "Mercer", "Warren"),
          geometry = TRUE, 
          output = "wide") 

dat_2011_tract <- dat_2011_tract %>%
  rename(total_pop = B01003_001E) %>%
  dplyr::select(GEOID, NAME, total_pop, geometry)


ggplot() +
  geom_sf(data = dat_2011_tract, aes(fill=factor(ntile(total_pop,5))), colour=NA) +
  scale_fill_manual(values = palette5,
                    labels=quintileBreaks(dat_2011_tract,"total_pop"),
                   name="Quintile\nBreaks") +
  labs(title="Population, New Jersey by census tract: 2011") +
  mapTheme

```

# 2.4 Highways 
```{r, warning = FALSE, message = FALSE, results = "hide"}
njHighways <-
  st_read("/Users/luyiiwong/Documents/GitHub/LandUseModeling_HW5/Data/nj_roads/NJ_Roadway_Network.shp") %>%
  st_zm() %>%
  st_transform(st_crs(njMSA)) %>%
  st_intersection(njMSA)
```

```{r plot_highway, warning = FALSE, message= FALSE}
ggplot() +
  geom_point(data=fishnet, 
             aes(x=xyC(fishnet)[,1], y=xyC(fishnet)[,2],colour=lc_change),size=1.5) +
  geom_sf(data= njHighways) +
  scale_colour_manual(values = palette2,
                      labels=c("No Change","New Development")) +
  labs(title = "New Development and Highways",
       subtitle = "As fishnet centroids") +
  mapTheme
```

# 2.5 Spatial Lag